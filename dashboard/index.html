<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #fafafa; --card: #fff; --border: #e5e5e5; --text: #222; --muted: #666; --accent: #2563eb; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; }

        .filters { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .filter-group label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
        select { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; background: var(--card); min-width: 140px; }
        select:focus { outline: 2px solid var(--accent); outline-offset: -1px; }

        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .metric { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; }
        .metric-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .metric-value { font-size: 1.75rem; font-weight: 600; margin-top: 0.25rem; }
        .metric-sub { font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; }
        .card h2 { font-size: 0.875rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .chart-wrap { height: 280px; position: relative; }

        .full { grid-column: 1 / -1; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-weight: 500; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:hover { background: #f9f9f9; }

        .recs { display: flex; flex-direction: column; gap: 0.75rem; }
        .rec { padding: 1rem; border-radius: 6px; border-left: 3px solid; }
        .rec.warn { background: #fffbeb; border-color: #f59e0b; }
        .rec.info { background: #eff6ff; border-color: #3b82f6; }
        .rec.good { background: #f0fdf4; border-color: #22c55e; }
        .rec-title { font-weight: 600; font-size: 0.875rem; }
        .rec-detail { font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem; }

        .empty { color: var(--muted); text-align: center; padding: 2rem; }

        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .metrics { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Transactions Dashboard</h1>

        <div class="filters">
            <div class="filter-group">
                <label>Currency</label>
                <select id="currency">
                    <option value="SGD">SGD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Period</label>
                <select id="period">
                    <option value="12">Last 12 months</option>
                    <option value="6">Last 6 months</option>
                    <option value="3">Last 3 months</option>
                    <option value="all">All time</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Type</label>
                <select id="type">
                    <option value="Expense">Expenses</option>
                    <option value="all">All</option>
                    <option value="Income">Income</option>
                    <option value="Investment">Investment</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Category</label>
                <select id="category">
                    <option value="all">All categories</option>
                </select>
            </div>
        </div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-label">Total</div>
                <div class="metric-value" id="m-total">-</div>
                <div class="metric-sub" id="m-count">- transactions</div>
            </div>
            <div class="metric">
                <div class="metric-label">Monthly Avg</div>
                <div class="metric-value" id="m-avg">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">Fixed Costs</div>
                <div class="metric-value" id="m-fixed">-</div>
                <div class="metric-sub" id="m-fixed-pct">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">Variable Costs</div>
                <div class="metric-value" id="m-var">-</div>
                <div class="metric-sub" id="m-var-pct">-</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Monthly Trend</h2>
                <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="card">
                <h2>By Category</h2>
                <div class="chart-wrap"><canvas id="catChart"></canvas></div>
            </div>
            <div class="card">
                <h2>Fixed vs Variable</h2>
                <div class="chart-wrap"><canvas id="fvChart"></canvas></div>
            </div>
            <div class="card">
                <h2>Top Categories</h2>
                <div class="table-wrap">
                    <table id="topTable">
                        <thead><tr><th>Category</th><th>Amount</th><th>%</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Recurring (Fixed) Costs</h2>
                <div class="table-wrap">
                    <table id="recurringTable">
                        <thead><tr><th>Category</th><th>Avg/mo</th><th>Total</th><th>#</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h2>Recommendations</h2>
                <div class="recs" id="recs"></div>
            </div>
        </div>
    </div>

<script>
let raw = [];
let filtered = [];
let charts = {};

// Load data
fetch('data/transactions.json')
    .then(r => r.json())
    .then(data => { raw = data; init(); })
    .catch(() => document.querySelector('.container').innerHTML = '<p class="empty">Load data first: <code>python fetch_data.py</code></p>');

function init() {
    // Populate category filter
    const cats = [...new Set(raw.map(d => d.category2))].filter(Boolean).sort();
    const sel = document.getElementById('category');
    cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);

    // Bind filters
    ['currency', 'period', 'type', 'category'].forEach(id =>
        document.getElementById(id).addEventListener('change', update));

    update();
}

function update() {
    const curr = document.getElementById('currency').value;
    const period = document.getElementById('period').value;
    const type = document.getElementById('type').value;
    const cat = document.getElementById('category').value;

    const cutoff = period !== 'all' ? new Date(Date.now() - parseInt(period) * 30 * 24 * 60 * 60 * 1000) : null;

    filtered = raw.filter(d => {
        if (d.translated_currency !== curr) return false;
        if (cutoff && new Date(d.local_date) < cutoff) return false;
        if (type !== 'all' && d.category3 !== type) return false;
        if (cat !== 'all' && d.category2 !== cat) return false;
        return true;
    });

    render();
}

function render() {
    // Sum actual values (negative = expense, positive = income)
    const totalSum = filtered.reduce((s, d) => s + (d.translated_amount || 0), 0);
    const months = new Set(filtered.map(d => d.local_date?.slice(0, 7))).size || 1;
    const fixed = filtered.filter(d => d.fixed_vs_variable === 'Fixed').reduce((s, d) => s + (d.translated_amount || 0), 0);
    const variable = filtered.filter(d => d.fixed_vs_variable?.startsWith('Variable')).reduce((s, d) => s + (d.translated_amount || 0), 0);
    const totalAbs = Math.abs(totalSum);

    const curr = document.getElementById('currency').value;
    const fmt = v => new Intl.NumberFormat('en', { style: 'currency', currency: curr === 'EUR' ? 'EUR' : 'SGD', maximumFractionDigits: 0, signDisplay: 'auto' }).format(v);

    document.getElementById('m-total').textContent = fmt(totalSum);
    document.getElementById('m-count').textContent = `${filtered.length} transactions`;
    document.getElementById('m-avg').textContent = fmt(totalSum / months);
    document.getElementById('m-fixed').textContent = fmt(fixed);
    document.getElementById('m-fixed-pct').textContent = totalAbs ? `${((Math.abs(fixed)/totalAbs)*100).toFixed(0)}% of total` : '-';
    document.getElementById('m-var').textContent = fmt(variable);
    document.getElementById('m-var-pct').textContent = totalAbs ? `${((Math.abs(variable)/totalAbs)*100).toFixed(0)}% of total` : '-';

    renderTrend(fmt);
    renderCategory(fmt);
    renderFV(fmt);
    renderTop(fmt, totalAbs);
    renderRecurring(fmt, months);
    renderRecs(fmt, months, totalAbs, Math.abs(fixed), Math.abs(variable));
}

function renderTrend(fmt) {
    const byMonth = {};
    filtered.forEach(d => {
        const m = d.local_date?.slice(0, 7);
        if (m) byMonth[m] = (byMonth[m] || 0) + (d.translated_amount || 0);
    });
    const sorted = Object.entries(byMonth).sort((a, b) => a[0].localeCompare(b[0]));

    if (charts.trend) charts.trend.destroy();
    charts.trend = new Chart(document.getElementById('trendChart'), {
        type: 'bar',
        data: {
            labels: sorted.map(s => s[0]),
            datasets: [{
                data: sorted.map(s => s[1]),
                backgroundColor: sorted.map(s => s[1] >= 0 ? '#22c55e' : '#2563eb'),
                borderRadius: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
    });
}

function renderCategory(fmt) {
    const byCat = {};
    filtered.forEach(d => { const c = d.category2 || 'Other'; byCat[c] = (byCat[c] || 0) + (d.translated_amount || 0); });
    const sorted = Object.entries(byCat).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1])).slice(0, 8);

    if (charts.cat) charts.cat.destroy();
    charts.cat = new Chart(document.getElementById('catChart'), {
        type: 'doughnut',
        data: {
            labels: sorted.map(s => `${s[0]} (${s[1] >= 0 ? '+' : ''}${Math.round(s[1])})`),
            datasets: [{ data: sorted.map(s => Math.abs(s[1])), backgroundColor: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe', '#eff6ff', '#f8fafc'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } } }
    });
}

function renderFV(fmt) {
    const byFV = {};
    filtered.forEach(d => { const t = d.fixed_vs_variable || 'Other'; byFV[t] = (byFV[t] || 0) + (d.translated_amount || 0); });

    if (charts.fv) charts.fv.destroy();
    charts.fv = new Chart(document.getElementById('fvChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(byFV),
            datasets: [{ data: Object.values(byFV), backgroundColor: ['#22c55e', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } } }
    });
}

function renderTop(fmt, total) {
    const byCat = {};
    filtered.forEach(d => { const c = d.category || 'Other'; byCat[c] = (byCat[c] || 0) + (d.translated_amount || 0); });
    const sorted = Object.entries(byCat).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1])).slice(0, 10);

    const tbody = document.querySelector('#topTable tbody');
    tbody.innerHTML = sorted.map(([c, v]) => `<tr><td>${c}</td><td>${fmt(v)}</td><td>${total ? ((Math.abs(v)/total)*100).toFixed(1) : 0}%</td></tr>`).join('');
}

function renderRecurring(fmt, months) {
    const byFixed = {};
    filtered.filter(d => d.fixed_vs_variable === 'Fixed').forEach(d => {
        const c = d.category;
        if (!byFixed[c]) byFixed[c] = { total: 0, count: 0 };
        byFixed[c].total += (d.translated_amount || 0);
        byFixed[c].count++;
    });
    const sorted = Object.entries(byFixed).sort((a, b) => Math.abs(b[1].total) - Math.abs(a[1].total)).slice(0, 10);

    const tbody = document.querySelector('#recurringTable tbody');
    tbody.innerHTML = sorted.map(([c, v]) => `<tr><td>${c}</td><td>${fmt(v.total / months)}</td><td>${fmt(v.total)}</td><td>${v.count}</td></tr>`).join('');
}

function renderRecs(fmt, months, total, fixed, variable) {
    const recs = [];

    // High fixed costs
    const fixedByCat = {};
    filtered.filter(d => d.fixed_vs_variable === 'Fixed').forEach(d => {
        fixedByCat[d.category] = (fixedByCat[d.category] || 0) + Math.abs(d.translated_amount || 0);
    });
    const highFixed = Object.entries(fixedByCat).filter(([_, v]) => v / months > 100).sort((a, b) => b[1] - a[1]);
    if (highFixed.length > 0) {
        recs.push({ type: 'warn', title: 'Review fixed costs', detail: `${highFixed.slice(0, 3).map(([k, v]) => `${k} (${fmt(v / months)}/mo)`).join(', ')} — can any be reduced?` });
    }

    // Subscriptions
    const subs = filtered.filter(d => d.category?.toLowerCase().includes('subscription'));
    if (subs.length > 2) {
        const subTotal = subs.reduce((s, d) => s + Math.abs(d.translated_amount || 0), 0);
        recs.push({ type: 'info', title: 'Subscription audit', detail: `${subs.length} subscriptions totaling ${fmt(subTotal)}. Review for unused services.` });
    }

    // Food spending
    const food = filtered.filter(d => d.category === 'Food' || d.category === 'Groceries').reduce((s, d) => s + Math.abs(d.translated_amount || 0), 0);
    if (food / months > 400) {
        recs.push({ type: 'info', title: 'Food spending', detail: `Avg ${fmt(food / months)}/mo on food. Meal planning could help reduce this.` });
    }

    // Good ratio
    if (fixed / total < 0.35) {
        recs.push({ type: 'good', title: 'Good flexibility', detail: `Fixed costs are only ${((fixed/total)*100).toFixed(0)}% of spending — room to save.` });
    }

    // Variable spending
    const varByCat = {};
    filtered.filter(d => d.fixed_vs_variable?.startsWith('Variable')).forEach(d => {
        varByCat[d.category2] = (varByCat[d.category2] || 0) + Math.abs(d.translated_amount || 0);
    });
    const highVar = Object.entries(varByCat).filter(([_, v]) => v / months > 200).sort((a, b) => b[1] - a[1]);
    if (highVar.length > 0) {
        recs.push({ type: 'info', title: 'Variable spending opportunities', detail: `Top variable: ${highVar.slice(0, 2).map(([k, v]) => `${k} (${fmt(v / months)}/mo)`).join(', ')}` });
    }

    if (recs.length === 0) {
        recs.push({ type: 'good', title: 'Looking good', detail: 'No major spending concerns detected.' });
    }

    document.getElementById('recs').innerHTML = recs.map(r => `<div class="rec ${r.type}"><div class="rec-title">${r.title}</div><div class="rec-detail">${r.detail}</div></div>`).join('');
}
</script>
</body>
</html>
